import pygeos
import numpy as np
import pandas as pd
import geopandas as gpd
import pyproj
gpd.options.use_pygeos = True
import shapely
from shapely.wkt import loads

from typing import Union
import momepy

def make_buffered_GHSL(ghsl_df: gpd.GeoDataFrame, filename=None) -> gpd.GeoDataFrame:
	# THIS FILE ASSUMES YOU'RE PASSING CRS 3395 AND RETURNS CRS 3395

	# Original projection is 4326
	ghsl_df = ghsl_df.to_crs(3395)
	if "Unique ID" not in ghsl_df.columns.tolist():
		ghsl_df = ghsl_df.rename(columns={"ID_HDC_G0": "Unique ID", "QA2_1V": "Quality Code","AREA": "Area","BBX_LATMN": "Bounding Box (WGS 84) Latitude Min","BBX_LONMN": "Bounding Box (WGS 84) Longitude Min","BBX_LATMX": "Bounding Box (WGS 84) Latitude Max","BBX_LONMX": "Bounding Box (WGS 84) Longitude Max","GCPNT_LAT": "Geometric Centroid (WGS 84) Latitude","GCPNT_LON": "Geometric Centroid (WGS 84) Longitude","CTR_MN_NM": "Main Country Identification Name","CTR_MN_ISO": "Main Country Identification ISO 3","XBRDR": "Cross border flag","XCTR_NBR": "Number of intersected countries","XC_NM_LST": "List of intersected countries: names","XC_ISO_LST": "List of intersected countries: ISO 3","GRGN_L1": "Major Geographical Region","GRGN_L2": "Geographical Region","UC_NM_MN": "Name of the Urban Centre","UC_NM_LST": "List of names","UC_NM_SRC": "Source of the names","H75_NBR": "Number of Urban Centres in 1975","H90_NBR": "Number of Urban Centres in 1990","H00_NBR": "Number of Urban Centres in 2000","H75_AREA": "Total area of Urban Centres in 1975","H90_AREA": "Total area of Urban Centres in 1990","H00_AREA": "Total area of Urban Centres in 2000","E_BM_NM_LST": "Biome type(s)","E_SL_LST": "Soil group(s)","EL_AV_ALS": "Average Elevation","E_KG_NM_LST": "Climate class(es)","E_RB_NM_LST": "Major river basin(s)","E_WR_P_90": "Average precipitation for epoch 1990","E_WR_P_00": "Average precipitation for epoch 2000","E_WR_P_14": "Average precipitation for epoch 2014","E_WR_T_90": "Average temperature for epoch 1990","E_WR_T_00": "Average temperature for epoch 2000","E_WR_T_14": "Average temperature for epoch 2014","B75": "Total built-up area in 1975","B90": "Total built-up area in 1990","B00": "Total built-up area in 2000","B15": "Total built-up area in 2015","P75": "Total resident population in 1975","P90": "Total resident population in 1990","P00": "Total resident population in 2000","P15": "Total resident population in 2015","BUCAP75": "Surface of the built-up area per person in 1975","BUCAP90": "Surface of the built-up area per person in 1990","BUCAP00": "Surface of the built-up area per person in 2000","BUCAP15": "Surface of the built-up area per person in 2015","NTL_AV": "Average night time light emission in 2015","GDP90_SM": "Sum of GDP PPP values for year 1990","GDP00_SM": "Sum of GDP PPP values for year 2000","GDP15_SM": "Sum of GDP PPP values for year 2015","INCM_CMI": "UN income class","DEV_CMI": "UN development group","TT2CC": "Travel time to country capital","E_GR_AV90": "Average greenness estimated for 1990 located in the built-up area of epoch 1990","E_GR_AV00": "Average greenness estimated for 2000 located in the built-up area of epoch 2000","E_GR_AV14": "Average greenness estimated for 2014 located in the built-up area of epoch 2014","E_GR_AH90": "Total area of the high green estimated for 1990","E_GR_AM90": "Total area of the medium green estimated for 1990","E_GR_AL90": "Total area of the low green estimated for 1990","E_GR_AT90": "Total area of green estimated for 1990","E_GR_AH00": "Total area of the high green estimated for 2000","E_GR_AM00": "Total area of the medium green estimated for 2000","E_GR_AL00": "Total area of the low green estimated for 2000","E_GR_AT00": "Total area of green estimated for 2000","E_GR_AH14": "Total area of the high green estimated for 2014","E_GR_AM14": "Total area of the medium green estimated for 2014","E_GR_AL14": "Total area of the low green estimated for 2014","E_GR_AT14": "Total area of green estimated for 2014","E_EC2E_E75": "Total emission of CO2 from the energy sector, using non-short-cycle-organic fuels in 1975","E_EC2E_E90": "Total emission of CO2 from the energy sector, using non-short-cycle-organic fuels in 1990","E_EC2E_E00": "Total emission of CO2 from the energy sector, using non-short-cycle-organic fuels in 2000","E_EC2E_E15": "Total emission of CO2 from the energy sector, using non-short-cycle-organic fuels in 2015","E_EC2E_R75": "Total emission of CO2 from the residential sector, using non-short-cycle-organic fuels in 1975","E_EC2E_R90": "Total emission of CO2 from the residential sector, using non-short-cycle-organic fuels in 1990","E_EC2E_R00": "Total emission of CO2 from the residential sector, using non-short-cycle-organic fuels in 2000","E_EC2E_R15": "Total emission of CO2 from the residential sector, using non-short-cycle-organic fuels in 2015","E_EC2E_I75": "Total emission of CO2 from the industry sector, using non-short-cycle-organic fuels in 1975","E_EC2E_I90": "Total emission of CO2 from the industry sector, using non-short-cycle-organic fuels in 1990","E_EC2E_I00": "Total emission of CO2 from the industry sector, using non-short-cycle-organic fuels in 2000","E_EC2E_I15": "Total emission of CO2 from the industry sector, using non-short-cycle-organic fuels in 2015","E_EC2E_T75": "Total emission of CO2 from the transport sector, using non-short-cycle-organic fuels in 1975","E_EC2E_T90": "Total emission of CO2 from the transport sector, using non-short-cycle-organic fuels in 1990","E_EC2E_T00": "Total emission of CO2 from the transport sector, using non-short-cycle-organic fuels in 2000","E_EC2E_T15": "Total emission of CO2 from the transport sector, using non-short-cycle-organic fuels in 2015","E_EC2E_A75": "Total emission of CO2 from the agriculture sector, using non-short-cycle-organic fuels in 1975","E_EC2E_A90": "Total emission of CO2 from the agriculture sector, using non-short-cycle-organic fuels in 1990","E_EC2E_A00": "Total emission of CO2 from the agriculture sector, using non-short-cycle-organic fuels in 2000","E_EC2E_A15": "Total emission of CO2 from the agriculture sector, using non-short-cycle-organic fuels in 2015","E_EC2O_E75": "Total emission of CO2 from the energy sector, using short-cycle-organic fuels in 1975","E_EC2O_E90": "Total emission of CO2 from the energy sector, using short-cycle-organic fuels in 1990","E_EC2O_E00": "Total emission of CO2 from the energy sector, using short-cycle-organic fuels in 2000","E_EC2O_E15": "Total emission of CO2 from the energy sector, using short-cycle-organic fuels in 2015","E_EC2O_R75": "Total emission of CO2 from the residential sector, using short-cycle-organic fuels in 1975","E_EC2O_R90": "Total emission of CO2 from the residential sector, using short-cycle-organic fuels in 1990","E_EC2O_R00": "Total emission of CO2 from the residential sector, using short-cycle-organic fuels in 2000","E_EC2O_R15": "Total emission of CO2 from the residential sector, using short-cycle-organic fuels in 2015","E_EC2O_I75": "Total emission of CO2 from the industry sector, using short-cycle-organic fuels in 1975","E_EC2O_I90": "Total emission of CO2 from the industry sector, using short-cycle-organic fuels in 1990","E_EC2O_I00": "Total emission of CO2 from the industry sector, using short-cycle-organic fuels in 2000","E_EC2O_I15": "Total emission of CO2 from the industry sector, using short-cycle-organic fuels in 2015","E_EC2O_T75": "Total emission of CO2 from the transport sector, using short-cycle-organic fuels in 1975","E_EC2O_T90": "Total emission of CO2 from the transport sector, using short-cycle-organic fuels in 1990","E_EC2O_T00": "Total emission of CO2 from the transport sector, using short-cycle-organic fuels in 2000","E_EC2O_T15": "Total emission of CO2 from the transport sector, using short-cycle-organic fuels in 2015","E_EC2O_A75": "Total emission of CO2 from the agriculture sector, using short-cycle-organic fuels in 1975","E_EC2O_A90": "Total emission of CO2 from the agriculture sector, using short-cycle-organic fuels in 1990","E_EC2O_A00": "Total emission of CO2 from the agriculture sector, using short-cycle-organic fuels in 2000","E_EC2O_A15": "Total emission of CO2 from the agriculture sector, using short-cycle-organic fuels in 2015","E_EPM2_E75": "Total emission of PM2.5 from the energy sector in 1975","E_EPM2_E90": "Total emission of PM2.5 from the energy sector in 1990","E_EPM2_E00": "Total emission of PM2.5 from the energy sector in 2000","E_EPM2_E15": "Total emission of PM2.5 from the energy sector in 2015","E_EPM2_R75": "Total emission of PM2.5 from the residential sector in 1975","E_EPM2_R90": "Total emission of PM2.5 from the residential sector in 1990","E_EPM2_R00": "Total emission of PM2.5 from the residential sector in 2000","E_EPM2_R15": "Total emission of PM2.5 from the residential sector in 2015","E_EPM2_I75": "Total emission of PM2.5 from the industry sector in 1975","E_EPM2_I90": "Total emission of PM2.5 from the industry sector in 1990","E_EPM2_I00": "Total emission of PM2.5 from the industry sector in 2000","E_EPM2_I15": "Total emission of PM2.5 from the industry sector in 2015","E_EPM2_T75": "Total emission of PM2.5 from the transport sector in 1975","E_EPM2_T90": "Total emission of PM2.5 from the transport sector in 1990","E_EPM2_T00": "Total emission of PM2.5 from the transport sector in 2000","E_EPM2_T15": "Total emission of PM2.5 from the transport sector in 2015","E_EPM2_A75": "Total emission of PM22.5 from the agriculture sector in 1975","E_EPM2_A90": "Total emission of PM2.5 from the agriculture sector in 1990","E_EPM2_A00": "Total emission of PM2.5 from the agriculture sector in 2000","E_EPM2_A15": "Total emission of PM2.5 from the agriculture sector in 2015","E_CPM2_T00": "Total concentration of PM2.5 for reference epoch 2000","E_CPM2_T05": "Total concentration of PM2.5 for reference epoch 2005","E_CPM2_T10": "Total concentration of PM2.5 for reference epoch 2010","E_CPM2_T14": "Total concentration of PM2.5 for reference epoch 2014","EX_FD_AREA": "Total surface potentially exposed to floods","EX_FD_B75": "Total built-up area potentially exposed to floods in 1975","EX_FD_B90": "Total built-up area potentially exposed to floods in 1990","EX_FD_B00": "Total built-up area potentially exposed to floods in 2000","EX_FD_B15": "Total built-up area potentially exposed to floods in 2015","EX_FD_P75": "Total resident population potentially exposed to floods in 1975","EX_FD_P90": "Total resident population potentially exposed to floods in 1990","EX_FD_P00": "Total resident population potentially exposed to floods in 2000","EX_FD_P15": "Total resident population potentially exposed to floods in 2015","EX_SS_AREA": "Total surface potentially exposed to storm surges","EX_SS_B75": "Total built-up area potentially exposed to storm surges in 1975","EX_SS_B90": "Total built-up area potentially exposed to storm surges in 1990","EX_SS_B00": "Total built-up area potentially exposed to storm surges in 2000","EX_SS_B15": "Total built-up area potentially exposed to storm surges in 2015","EX_SS_P75": "Total resident population potentially exposed to storm surges in 1975","EX_SS_P90": "Total resident population potentially exposed to storm surges in 1990","EX_SS_P00": "Total resident population potentially exposed to storm surges in 2000","EX_SS_P15": "Total resident population potentially exposed to storm surges in 2015","EX_EQ19PGA": "Average peak ground acceleration (PGA) estimate of the seismic risk","EX_EQ19MMI": "MMI class of the seismic risk, derived from the PGA estimate","EX_EQ19_Q": "Quality control value","EX_HW_IDX": "Maximum magnitude of the heatwaves","SDG_LUE9015": "Land use efficiency 1990-2015","SDG_A2G14": "Share of population living in the high green area in 2015","Percentage of the open spaces": "SDG_OS15MX", "geometry": "geometry"})

	# Creating buffer that's whichever smaller of 1 km and 5% of the area
	# This makes a lot of the geometries barely buffered at all, some can be as little as a meter
	# The below #s are in meters
	ghsl_df['max_buffer_dist'] = ghsl_df.area.apply(lambda x: min(1000, x*10e-6*0.25))
	# https://github.com/geopandas/geopandas/issues/2015
	limit = ghsl_df.geometry.buffer(ghsl_df['max_buffer_dist'])
	# This lets us do a buffer with no overlaps
	ghsl_df_tess = momepy.Tessellation(ghsl_df, unique_id='Unique ID', limit=limit, segment=1000, shrink=250).tessellation
	ghsl_df_merged = ghsl_df_tess.merge(ghsl_df.drop(columns=['geometry', 'max_buffer_dist']), how='left', on='Unique ID')
	if filename:
		ghsl_df_merged.to_parquet(filename)
	return ghsl_df_merged